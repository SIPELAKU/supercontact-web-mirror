# ==============================================================================
# SUPERCONTACT WEB - CI/CD PIPELINE
# ==============================================================================
# This pipeline handles testing, building, and mirroring to GitHub

# ==============================================================================
# KONFIGURASI VARIABEL
# ==============================================================================
variables:
  GIT_DEPTH: 0
  NODE_VERSION: "18"

# ==============================================================================
# DEFINISI STAGES
# ==============================================================================
stages:
  - test
  - build
  - mirror-dev
  - promote-staging
  - promote-main

# ==============================================================================
# CACHE CONFIGURATION
# ==============================================================================
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - .next/cache/

# ==============================================================================
# JOB: TESTING & LINTING
# ==============================================================================
test_and_lint:
  stage: test
  image: node:${NODE_VERSION}-alpine
  before_script:
    - echo "üì¶ Installing dependencies..."
    - npm ci --prefer-offline --no-audit
  script:
    - echo "üîç Running ESLint..."
    - npm run lint
    - echo "üîç Running TypeScript type checking..."
    - npx tsc --noEmit
    - echo "‚úÖ All tests and linting passed!"
  artifacts:
    reports:
      junit: junit.xml
    expire_in: 1 week
  only:
    - dev
    - staging
    - main
    - merge_requests

# ==============================================================================
# JOB: BUILD APPLICATION
# ==============================================================================
build_application:
  stage: build
  image: node:${NODE_VERSION}-alpine
  before_script:
    - echo "üì¶ Installing dependencies..."
    - npm ci --prefer-offline --no-audit
  script:
    - echo "üèóÔ∏è Building Next.js application..."
    - npm run build
    - echo "‚úÖ Build completed successfully!"
  artifacts:
    paths:
      - .next/
      - out/
    expire_in: 1 week
  only:
    - dev
    - staging
    - main
  needs:
    - test_and_lint

# ==============================================================================
# SCRIPT PERSIAPAN UNTUK MIRROR
# ==============================================================================
.mirror_setup: &mirror_setup
  image: bitnami/git:latest
  before_script:
    - echo "‚öôÔ∏è Memulai konfigurasi Environment..."
    
    # Konfigurasi Identitas
    - git config --global user.email "ci-bot@solvera.com"
    - git config --global user.name "CI/CD Bot"
    
    # Setup Remote GitHub
    - git remote add github https://$GITHUB_USER:$GITHUB_TOKEN@github.com/$GITHUB_USER/supercontact-web-mirror.git || true
    
    # Setup Remote GitLab
    - git remote set-url origin https://oauth2:$GITLAB_ACCESS_TOKEN@gitlab.com/$CI_PROJECT_PATH.git

    # Fetch Semua Branch
    - git fetch --all
    - echo "‚úÖ Konfigurasi selesai."

# ==============================================================================
# JOB: DEVELOPMENT (AUTO SYNC)
# ==============================================================================
sync_dev_to_github:
  <<: *mirror_setup
  stage: mirror-dev
  script:
    - echo "=================================================="
    - echo "üîÑ [DEV] Memulai Sinkronisasi ke GitHub..."
    - echo "=================================================="
    
    # PERBAIKAN: Memaksa checkout dari 'origin/dev' agar tidak bingung
    - git checkout -B dev origin/dev
    
    # Kirim ke GitHub
    - git push github dev --force
    
    - echo "‚úÖ [SUCCESS] Dev berhasil disinkronkan!"
  only:
    - dev
  needs:
    - build_application

# ==============================================================================
# JOB: PROMOTION (DEV -> STAGING)
# ==============================================================================
approve_to_staging:
  <<: *mirror_setup
  stage: promote-staging
  script:
    - echo "=================================================="
    - echo "üöÄ [STAGING] Memproses Merge Request (Dev -> Staging)..."
    - echo "=================================================="
    
    # PERBAIKAN: Memaksa checkout 'staging' dari origin
    - git checkout -B staging origin/staging
    
    # Lakukan Merge
    - echo "üîÄ Merging 'origin/dev' into 'staging'..."
    - git merge origin/dev --no-edit
    
    # Push ke GitLab & GitHub
    - echo "‚¨ÜÔ∏è Pushing update..."
    - git push origin staging
    - git push github staging --force
    
    - echo "‚úÖ [SUCCESS] Staging berhasil diupdate!"
  only:
    - dev
  when: manual
  allow_failure: false

# ==============================================================================
# JOB: PROMOTION (STAGING -> MAIN)
# ==============================================================================
approve_to_production:
  <<: *mirror_setup
  stage: promote-main
  script:
    - echo "=================================================="
    - echo "üöÄ [PRODUCTION] Memproses Release (Staging -> Main)..."
    - echo "=================================================="
    
    # PERBAIKAN: Memaksa checkout 'main' dari origin
    - git checkout -B main origin/main
    
    # Lakukan Merge
    - echo "üîÄ Merging 'origin/staging' into 'main'..."
    - git merge origin/staging --no-edit
    
    # Push ke GitLab & GitHub
    - echo "‚¨ÜÔ∏è Pushing update..."
    - git push origin main
    - git push github main --force
    
    - echo "‚úÖ [SUCCESS] Production berhasil diupdate!"
  only:
    - staging
  when: manual
  allow_failure: false

# ==============================================================================
# REQUIRED VARIABLES IN GITLAB CI/CD SETTINGS:
# - GITHUB_USER: GitHub username
# - GITHUB_TOKEN: GitHub personal access token
# - GITLAB_ACCESS_TOKEN: GitLab access token
# ==============================================================================